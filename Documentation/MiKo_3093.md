# MiKo_3093: Do not invoke delegates inside locks

## Cause

A delegate is invoked within a lock statement.

## Rule description

To avoid deadlocks, do not invoke delegates within lock statements.
Collect the necessary information inside the lock, then invoke the delegate outside the lock.
This practice ensures smooth and efficient code execution while avoiding potential deadlocks.

### Rationale behind

Invoking delegates inside lock statements allows external code to execute while holding a lock.
Like raising events in locks, this is a common cause of deadlocks and performance problems in multithreaded applications.

Avoiding delegate invocation in locks provides several important benefits:

- **Prevents Deadlocks**:
  Delegates can execute arbitrary code that might attempt to acquire locks.
  If delegate code tries to acquire the same lock that is currently held, or if it acquires locks in a different order than other threads, a deadlock will occur.

- **Reduces Lock Hold Time**:
  Delegates can execute complex or time-consuming operations.
  Holding locks while delegates run increases lock contention and can significantly degrade application performance.

- **Avoids Reentrancy Problems**:
  Delegates might call back into the same object that invoked them.
  This can cause reentrancy issues if the object assumes it has exclusive access during the lock, potentially corrupting object state.

- **Improves Code Predictability**:
  When delegates execute outside locks, the scope of synchronization is clear and limited.
  This makes the code easier to understand and reason about for thread safety.

- **Enables Better Performance**:
  Releasing locks before invoking delegates allows other threads to make progress.
  This reduces thread blocking and improves overall application throughput.

- **Simplifies Testing**:
  Code that invokes delegates outside locks is easier to test for thread safety scenarios.
  Test cases do not need to account for complex interactions between delegate code and lock behavior.

## How to fix violations

To fix a violation of this rule, capture all necessary data inside the lock and store it in local variables.
Release the lock before invoking the delegate with the captured data.
This ensures that the delegate executes outside the lock while still maintaining thread safety for the shared data.

## How to suppress violations

```csharp
#pragma warning disable MiKo_3093
#pragma warning restore MiKo_3093
```
