# MiKo_3091: Do not raise events in finally blocks

## Cause

A finally block contains code that raises an event.

## Rule description

Raise events within try or catch blocks, not finally blocks.
Finally blocks are meant for cleanup, ensuring certain code always runs.
This maintains their intended purpose and keeps the code clear.

### Rationale behind

Finally blocks are designed specifically for cleanup operations that should execute reliably regardless of exceptions.
Raising events from finally blocks violates this design principle and can cause unexpected behavior in event handling.

Avoiding event raising in finally blocks provides several important benefits:

- **Prevents Event Ordering Issues**:
  Events raised from finally blocks execute after exception handling completes, which can result in events being raised in unexpected order.
  This can confuse subscribers that expect events in a specific sequence.

- **Avoids Exception Masking**:
  If an event handler throws an exception while processing an event from a finally block, it can mask exceptions that occurred in the try or catch blocks.
  This makes debugging significantly more difficult.

- **Maintains Cleanup Focus**:
  Finally blocks should contain only cleanup code that is essential and unlikely to fail.
  Event raising can trigger arbitrary user code, which goes against the principle of finally blocks being simple and reliable.

- **Prevents Unexpected Side Effects**:
  Event handlers can have complex side effects that should not be part of cleanup logic.
  Raising events during cleanup can cause these side effects at inappropriate times in the application flow.

- **Reduces Reentrancy Problems**:
  Event handlers might attempt to call back into the same code that is cleaning up.
  This can cause reentrancy issues and leave the object in an inconsistent state during cleanup.

- **Improves Error Handling Clarity**:
  When events are only raised from try or catch blocks, the error handling flow is clear and predictable.
  Events from finally blocks blur the line between normal operation and cleanup.

## How to fix violations

To fix a violation of this rule, move the event raising code from the finally block to the appropriate location in the try or catch block.
If the event must be raised regardless of exceptions, raise it at the end of the try block and again in the catch block if needed.
Consider using a flag variable to track whether the event needs to be raised during cleanup.

## How to suppress violations

```csharp
#pragma warning disable MiKo_3091
#pragma warning restore MiKo_3091
```
